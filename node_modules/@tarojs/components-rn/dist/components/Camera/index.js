var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import React, { Component } from 'react';
import View from '../View';
import Text from '../Text';
import { Camera } from 'expo-camera';
import { BarCodeScanner } from 'expo-barcode-scanner';
// @ts-ignore
global._taroCamera = undefined;
export class _Camera extends Component {
    constructor(props) {
        super(props);
        this.ref = React.createRef();
        this.onError = (event) => {
            // @ts-ignore
            this.props.onError && this.props.onError(event);
        };
        this.onInitDone = () => {
            // @ts-ignore
            global._taroCamera = this.ref && this.ref.current;
            // @ts-ignore
            this.props.onInitDone && this.props.onInitDone();
        };
        this.onScanCode = (event) => {
            const { data } = event;
            // @ts-ignore
            this.props.onScanCode && this.props.onScanCode(Object.assign({ detail: {
                    result: data
                } }, event));
        };
        this.state = {
            hasPermission: null,
        };
    }
    componentDidMount() {
        return __awaiter(this, void 0, void 0, function* () {
            const { status } = yield Camera.requestPermissionsAsync();
            this.setState({
                hasPermission: status === 'granted'
            });
        });
    }
    render() {
        const { hasPermission } = this.state;
        const { devicePosition, style, mode, flash } = this.props;
        const type = !devicePosition ? null : Camera.Constants.Type[devicePosition];
        if (hasPermission === null) {
            return React.createElement(View, null);
        }
        if (hasPermission === false) {
            return React.createElement(Text, null, "No access to camera");
        }
        const barCodeScannerSettings = mode === 'scanCode'
            ? {
                barCodeScannerSettings: {
                    barCodeTypes: [BarCodeScanner.Constants.BarCodeType.qr]
                },
                onBarCodeScanned: this.onScanCode
            }
            : {};
        return (React.createElement(Camera, Object.assign({ ref: this.ref, type: type, flashMode: flash, onMountError: this.onError, onCameraReady: this.onInitDone, ratio: this.props.ratio }, barCodeScannerSettings, { style: [{ width: 300, height: 300 }, style] })));
    }
}
export default _Camera;
//# sourceMappingURL=index.js.map